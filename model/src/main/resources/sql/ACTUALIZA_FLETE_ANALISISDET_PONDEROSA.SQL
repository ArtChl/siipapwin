DROP TABLE ANALISISDET_G012_TEMP

CREATE TABLE ANALISISDET_G012_TEMP AS
SELECT A.ANALISISDET_ID,A.COM_ID,A.ARTCLAVE,A.CANTIDAD,A.NETO,
A.IMPORTE,B.FECHA
,0 AS PARTICIPACION
,(SELECT SUM(A.IMPORTE) FROM SW_ANALISISDET A JOIN SW_ANALISIS B ON(A.ANALISIS_ID=B.ANALISIS_ID)  WHERE A.COM_ID IN(SELECT COM_ID FROM V_COMS  WHERE PROVCLAVE='G012' AND FENT  between @FECHA_INI and @FECHA_FIN)) AS TOTAL_G012
,@IMPORTE AS FLETE_TOTALMES
,0 AS FLETE
,0 AS IMPORTE_CON_FLETE
,0 AS NETO_CON_FLETE
FROM SW_ANALISISDET A JOIN SW_ANALISIS B ON(A.ANALISIS_ID=B.ANALISIS_ID) 
WHERE 
A.COM_ID IN(
        SELECT COM_ID FROM V_COMS  WHERE PROVCLAVE=\'G012\' AND FENT  between @FECHA_INI and @FECHA_FIN
)

UPDATE ANALISISDET_G012_TEMP SET PARTICIPACION=IMPORTE/TOTAL_G012

UPDATE ANALISISDET_G012_TEMP SET FLETE=PARTICIPACION*FLETE_TOTALMES

UPDATE ANALISISDET_G012_TEMP SET IMPORTE_CON_FLETE=IMPORTE+FLETE

UPDATE ANALISISDET_G012_TEMP SET NETO_CON_FLETE=IMPORTE_CON_FLETE/CANTIDAD

SELECT * FROM ANALISISDET_G012_TEMP

CREATE TABLE SW_ANALISIS_DET_26_02_2009 AS SELECT * FROM SW_ANALISISDET

UPDATE SW_ANALISISDET A SET A.NETO=(SELECT X.NETO_CON_FLETE FROM ANALISISDET_G012_TEMP X WHERE X.ANALISISDET_ID=A.ANALISISDET_ID)
WHERE A.ANALISISDET_ID IN(SELECT ANALISISDET_ID FROM ANALISISDET_G012_TEMP)